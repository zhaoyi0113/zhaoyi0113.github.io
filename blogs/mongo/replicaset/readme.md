# 多数据中心环境下的MongoDB部署

现如今的互联网应用，我觉得应当称之为数据应用。在为用户提供服务之后，首先要考虑的就是如何利用用户数据来设计下一阶段的产品。为了获得数据，各大IT主管，技术总监，CTO可谓是较劲脑汁，哪怕是一丁点儿的数据，只要用户数量足够庞大，都能产生有价值的业务信息。当你的数据面越来越广，用户数量越来越多的时候，存储这些数据就成了产品发展的瓶颈。于是，各种大数据存储，私有云、公有云存储不断涌现。有的企业为了存储大数据不惜重金搭建自己的数据服务中心。与传统关系型数据库相比，NoSQL在这方面具有得天独厚的优势，没有数据库表的约束，没有严格的结构定义，备份恢复灵活，数据迁移方便，在NoSQL里MongoDB又是一款普遍采用的数据库类型。本文将讨论在多数据中心环境下，如何发挥MongoDB的存储特长。

## 数据库高可用

众所周知，企业各种信息化管理都采用数据库来作为存储方案，企业对这些数据访问的连续性要求越来越高，尤其是最近几年国内企业的快速发展，不少企业的业务范围已经发展到了海外市场，我们除了为中国企业骄傲之外，应当考虑更多的是如何满足并支持这种发展趋势。作为IT从业人员，我们的出发点更多的是从技术角度开始，在技术上保持领先地位才是保证企业业务不受局限的必要条件之一。为了避免因为数据的中断导致各种损失，数据库高可用构架已经成为企业信息化建设中的重中之重。

那么什么是数据库的高可用？我们先从业务场景分析一下。我们以银行业为例，假如你去一家银行存钱，银行柜台工作人员会把数据录入进银行数据库，等你下次查询或者取款时可以看到这比存款纪录。好了，目前为止没有什么意外发生。但是，对于任何一家银行来说，他们不可能只有一个营业窗口，也不可能只有一台ATM取款机。银行的营业网点遍布在全国各个城市、大街小巷。你在一台机器上进行的操作可以在其他任何一个城市、网店查询到。任何一台服务器或者数据库都不可能保证常年正常运行，每台机器都会有一定时间的宕机，而这个时间通常是在允许的范围之内。当数据库宕机时，我们如何保证数据的正常录入和读取呢？

一种常见的解决方法就是主从备份（Master-Slave），每个数据中心都会有多台数据库服务器，其中一台是主数据库，另外的都是从数据库。没台数据库都存储了全部数据的拷贝。每一次数据库的修改操作都先发送到主服务器上，然后由主服务器广播给所有从服务器，从而从服务器也就进行了相应的数据更新。你的应用程序是需要知道主数据库的地址，主数据库和从数据库之间的操作都是在服务器内部来进行的。如果你有一台主数据库，三台从数据库，实际上你就拥有了全部数据的四份拷贝，任何一台数据库宕机或者数据丢失都可以通过其他数据库恢复回来。这就是所谓的数据库高可用的简单构架。下面我们来看一下MongoDB中的高可用是如何设计的。

当所有数据库服务器都存储在一个数据中心时，我们可能会担心如果改数据中心整个瘫痪怎么办，瘫痪有可能是由供电系统导致，也有可能是人为破坏，还有可能是收到战争攻击。不论是什么原因，我们不想把所有赌注都压到一个数据中心上。此时，就有了多个数据中心部署的解决方案。那么，当一套数据库集群部署到多个数据中心时，我们如何保证数据的同步，或者说如何处理当一台服务器宕机导致的服务不可用呢？

## Replica Set

在MongoDB世界中，高可用是通过Replica来实现的，Replica这个单词的字面意思是“复制品”，所以说在Replica Set中每一台数据库都存储了一份全部数据的拷贝，所有数据库的存储内容都是一样的。对外来说整个Replica Set只有一个入口，应用程序服务器只需要通过这一个入口来进行数据库操作。Replica Set内部是由多台角色不同的MongoDB服务器组成，每台服务器相当于是一个`mongod`进程，共分为`Master`, `Secondary`和`Arbiter`。

- Master：提供所有数据库的写操作
- Secondary：存储Master上全部数据库的备份。当Master不可访问时，Secondary会接替Master的工作继续对外提供服务
- Arbiter：这是一个比较独特的成员，他并不存储任何数据库，当Master无法访问时，他只作为推选新Master的一个投票成员。下面我们会详细介绍他的作用。

一般一个Replica Set最少有3个成员负责存储数据，一个Master，两个Secondary。从MongoDB 3.0以后，一个Replica Set中最多可以有50个成员，但是其中Arbiter只能有7个。下图是一个拥有三个成员的Replica Set，一个Master，两个Secondary。

